---
import { Image } from 'astro:assets';

const { card, index, loading, adsEnabled = true, adSlots = [24, 66] } = Astro.props;
const showAd = adsEnabled && Array.isArray(adSlots) && adSlots.includes(index);
---

<article data-index={index} class="group relative">
	<a
		href={card.link}
		class="group block h-full overflow-hidden rounded-sm border border-sky-900 bg-sky-800/80 transition hover:-translate-y-0.5 hover:border-sky-400 hover:bg-sky-700/90"
	>
		<div class="aspect-square bg-[#0b3550]">
			<Image
				class="h-full w-full object-contain object-center"
				src={card.image}
				alt={card.name}
				sizes="(min-width: 1280px) 12vw, (min-width: 1024px) 16vw, (min-width: 768px) 24vw, 45vw"
				width={160}
				height={160}
				loading={loading}
			/>
		</div>
		<div class="border-t border-sky-900 px-2 py-1.5">
			<p class="truncate text-base font-semibold text-white/95" title={card.name}>{card.name}</p>
		</div>
	</a>
	<div
		class="pointer-events-none absolute bottom-full left-1/2 z-20 mb-2 w-max max-w-72 -translate-x-1/2 rounded-md border border-sky-400 bg-[#06283d] px-3 py-2 text-sm font-semibold text-white opacity-0 shadow-lg transition-opacity duration-150 group-hover:opacity-100 group-focus-within:opacity-100"
		role="tooltip"
	>
		{card.name}
	</div>
</article>

{
	showAd ? (
		<div class="col-span-2 row-span-1 aspect-[16/10] rounded-sm border border-sky-900 bg-black/70 overflow-hidden text-center">
			<ins
				class="adsbygoogle"
				style="display:block"
				data-ad-format="fluid"
				data-ad-layout-key="-dh-68+xg-dr-1ye"
				data-ad-client="ca-pub-8524094599848175"
				data-ad-slot="3379583016"
				data-compact-ad="true"
			/>
		</div>
	) : null
}

<script>
	type AdInsElement = HTMLModElement & { dataset: DOMStringMap };
	type AdsWindow = Window & { adsbygoogle?: unknown[] };

	const adElements = Array.from(
		document.querySelectorAll<AdInsElement>('ins.adsbygoogle[data-compact-ad="true"]')
	);

	const pushWhenReady = (element: AdInsElement): void => {
		if (element.dataset.adsInitialized === 'true') return;

		const containerWidth = element.parentElement?.getBoundingClientRect().width ?? 0;
		if (containerWidth < 250) return;

		const adsWindow = window as AdsWindow;
		const queue = adsWindow.adsbygoogle ?? [];
		adsWindow.adsbygoogle = queue;

		try {
			queue.push({});
			element.dataset.adsInitialized = 'true';
		} catch {
			// Retry on next resize/intersection when AdSense is ready.
		}
	};

	for (const element of adElements) {
		pushWhenReady(element);
	}

	const resizeObserver = new ResizeObserver((entries) => {
		for (const entry of entries) {
			const element = entry.target.querySelector<AdInsElement>('ins.adsbygoogle[data-compact-ad="true"]');
			if (element) pushWhenReady(element);
		}
	});

	const intersectionObserver = new IntersectionObserver((entries) => {
		for (const entry of entries) {
			if (!entry.isIntersecting) continue;
			const element = entry.target.querySelector<AdInsElement>('ins.adsbygoogle[data-compact-ad="true"]');
			if (element) pushWhenReady(element);
		}
	});

	for (const element of adElements) {
		const container = element.parentElement;
		if (!container) continue;
		resizeObserver.observe(container);
		intersectionObserver.observe(container);
	}
</script>
