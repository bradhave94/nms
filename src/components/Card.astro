---
import { Image } from 'astro:assets'

import credit from '../assets/img/credits.png';
const { card, index, loading, showHomeAd = false } = Astro.props;
---

<article data-index={index}>
	<a
		href={card.link}
		class="flex flex-wrap flex-col  transition border border-black hover:border-blue-500 bg-black rounded-md overflow-hidden h-full"
	>
		<div class="sm:basis-40 min-h-48">
			<Image
				class="aspect-square h-full w-full object-contain object-center p-1"
				src={card.image}
				alt={card.name}
				sizes="200px"
				width={200}
				height={200}
				loading={loading}
			/>
		</div>

		<div class="flex flex-1 flex-col justify-between">
			<div class="border-l p-4 border-white/10 sm:!border-l-transparent sm:p-6">
				<h2 class="font-bold text-3xl tracking-wider text-white">
					{card.name}
				</h2>
				{
					card.value ? (
						<p class="flex items-center gap-2 py-2 pb-4">
							<Image
								src={credit}
								alt="Credits"
								sizes="25px"
								width={25}
								height={25}
							/>
							{card.value}
						</p>
					) : null
				}

				<p
					class="mt-2 leading-relaxed xl:tracking-wider text-sm xl:text-base text-gray-200"
				>
					{card.description}
				</p>
			</div>

			<div class="sm:flex sm:items-end sm:justify-end">
				<button
					class="block tracking-wider bg-blue-500 px-5 py-3 text-center text-xs font-bold text-gray-900 transition hover:bg-blue-700"
				>
					{card.button}
				</button>
			</div>
		</div>
	</a>
</article>

{
	showHomeAd ? (
		<div class="sm:col-span-2 xl:col-span-2 rounded-md border border-sky-900 bg-black overflow-hidden text-center min-h-[140px]">
			<ins
				class="adsbygoogle"
				style="display:block"
				data-ad-format="fluid"
				data-ad-layout-key="-dh-68+xg-dr-1ye"
				data-ad-client="ca-pub-8524094599848175"
				data-ad-slot="3379583016"
				data-home-ad="true"
			/>
		</div>
	) : null
}

<script>
	type AdInsElement = HTMLModElement & { dataset: DOMStringMap };
	type AdsWindow = Window & { adsbygoogle?: unknown[] };

	const adElements = Array.from(
		document.querySelectorAll<AdInsElement>('ins.adsbygoogle[data-home-ad="true"]')
	);

	const pushWhenReady = (element: AdInsElement): void => {
		if (element.dataset.adsInitialized === 'true') return;

		const containerWidth = element.parentElement?.getBoundingClientRect().width ?? 0;
		if (containerWidth < 250) return;

		const adsWindow = window as AdsWindow;
		const queue = adsWindow.adsbygoogle ?? [];
		adsWindow.adsbygoogle = queue;

		try {
			queue.push({});
			element.dataset.adsInitialized = 'true';
		} catch {
			// Retry on next resize/intersection when AdSense is ready.
		}
	};

	for (const element of adElements) {
		pushWhenReady(element);
	}

	const resizeObserver = new ResizeObserver((entries) => {
		for (const entry of entries) {
			const element = entry.target.querySelector<AdInsElement>('ins.adsbygoogle[data-home-ad="true"]');
			if (element) pushWhenReady(element);
		}
	});

	const intersectionObserver = new IntersectionObserver((entries) => {
		for (const entry of entries) {
			if (!entry.isIntersecting) continue;
			const element = entry.target.querySelector<AdInsElement>('ins.adsbygoogle[data-home-ad="true"]');
			if (element) pushWhenReady(element);
		}
	});

	for (const element of adElements) {
		const container = element.parentElement;
		if (!container) continue;
		resizeObserver.observe(container);
		intersectionObserver.observe(container);
	}
</script>