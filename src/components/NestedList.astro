---
import { Image } from 'astro:assets'
import Accordion from '@components/Accordion.astro';
import { getSlug } from '@utils/lookup.js';

interface NestedItem {
  Id: string;
  Name: string;
  Icon: string;
  Quantity?: number;
  RequiredItems?: NestedItem[];
}

interface Props {
  items: NestedItem;
  depth?: number;
}

const { items, depth = 0 } = Astro.props;
---

{items.RequiredItems?.map((item, index) => {
  const quantity = (item.Quantity ?? 1) * (items.Quantity ?? 1);
  return item.RequiredItems?.length ? (
    <div class="crafting-tree-node border-l border-gray-600/50 pl-4 ml-2">
      <Accordion>
        <div data-index={index} class="flex items-center gap-3 py-1.5" slot="title">
          <a class="flex items-center gap-3 hover:opacity-90 transition-opacity min-w-0 flex-1" href={getSlug(item.Id)}>
            <Image
              src={`https://nomansskyrecipes.com/images/items/${item.Icon}`}
              alt={item.Name}
              sizes="40px"
              width={40}
              height={40}
              class="flex-shrink-0"
            />
            <span class="text-white font-medium truncate">
              {item.Name} x<span data-quantity={quantity}>{quantity.toLocaleString()}</span>
            </span>
          </a>
        </div>
        <div slot="content">
          <Astro.self items={{ ...item, Quantity: quantity }} depth={depth + 1} />
        </div>
      </Accordion>
    </div>
  ) : (
    <a
      href={getSlug(item.Id)}
      class="crafting-tree-leaf flex items-center gap-3 py-1.5 pl-4 ml-2 border-l-2 border-cyan-500/40 hover:bg-cyan-500/10 transition-colors rounded-r"
      data-index={index}
    >
      <Image
        src={`https://nomansskyrecipes.com/images/items/${item.Icon}`}
        alt={item.Name}
        sizes="36px"
        width={36}
        height={36}
        class="flex-shrink-0"
      />
      <span class="text-cyan-200 font-medium">
        {item.Name} x<span data-quantity={quantity}>{quantity.toLocaleString()}</span>
      </span>
    </a>
  );
})}