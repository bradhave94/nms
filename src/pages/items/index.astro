---
import Layout from '@layouts/Layout.astro';
import CompactCard from '@components/CompactCard.astro';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import { getSlug, sort } from '@utils/lookup.js';
import { getSiteOrigin } from '@utils/structuredData.js';
import { buildCategoryBreadcrumbs } from '@utils/seo.js';
import type { Item } from '@utils/lookup.js';
import * as dataSources from '@datav2/index.js';

const IMAGE_BASE = 'https://nomansskyrecipes.com/images/items/';

const getTypeFromSlug = (slug: string): string => {
	const prefix = slug.split('/')[1]?.split('/')[0] || '';
	const typeMap: Record<string, string> = {
		raw: 'raw',
		products: 'products',
		food: 'food',
		curiosities: 'curiosities',
		fish: 'fish',
		technology: 'technology',
		other: 'other',
		refinery: 'refinery',
		'nutrient-processor': 'food',
		buildings: 'buildings',
		upgrades: 'upgrades',
		exocraft: 'exocraft',
		starships: 'starships',
		corvette: 'corvette',
	};
	return typeMap[prefix] || prefix;
};

const allData = sort(Object.values(dataSources).flatMap((source) => source as Item[])).filter(
	(item) => item?.Name != null && String(item.Name).trim() !== ''
);

const itemCards = allData.map((item) => {
	const url = getSlug(item);
	return {
		id: item.Id,
		name: item.Name,
		icon: item.Icon,
		url,
		group: item.Group ?? '',
		type: getTypeFromSlug(url),
	};
});

const groups = [...new Set(itemCards.map((item) => item.group).filter(Boolean))].sort((a, b) =>
	a.localeCompare(b)
);
const types = [...new Set(itemCards.map((item) => item.type).filter(Boolean))].sort((a, b) => a.localeCompare(b));

const siteOrigin = getSiteOrigin(Astro.site, Astro.url);
const canonicalUrl = new URL(Astro.url.pathname, siteOrigin).toString();
const breadcrumbSchema = {
	'@context': 'https://schema.org',
	'@type': 'BreadcrumbList',
	'@id': `${canonicalUrl}#breadcrumb`,
	itemListElement: [
		{ '@type': 'ListItem', position: 1, name: 'Home', item: `${siteOrigin}/` },
		{ '@type': 'ListItem', position: 2, name: 'Items', item: canonicalUrl },
	],
};
const datasetSchema = {
	'@context': 'https://schema.org',
	'@type': 'Dataset',
	'@id': `${siteOrigin}/items.json#dataset`,
	name: "No Man's Sky Items Dataset",
	description: "Structured list of item names, groups, icons, and URLs used by No Man's Sky Recipes.",
	url: `${siteOrigin}/items.json`,
	isAccessibleForFree: true,
	inLanguage: 'en',
	creator: { '@id': `${siteOrigin}#organization` },
	distribution: {
		'@type': 'DataDownload',
		name: "No Man's Sky Items JSON Feed",
		contentUrl: `${siteOrigin}/items.json`,
		encodingFormat: 'application/json',
	},
};
const collectionSchema = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	'@id': `${canonicalUrl}#collection`,
	url: canonicalUrl,
	name: 'Items',
	description: "Browse items by group, type, or search. Filter No Man's Sky items dynamically.",
	isPartOf: { '@id': `${siteOrigin}#website` },
	breadcrumb: { '@id': `${canonicalUrl}#breadcrumb` },
	mainEntity: { '@id': `${siteOrigin}/items.json#dataset` },
};
const structuredData = [breadcrumbSchema, collectionSchema, datasetSchema];
const breadcrumbs = buildCategoryBreadcrumbs('Items', '/items', 1);
---

<Layout
	title="Items | No Man's Sky Recipes"
	description="Browse items by group, type, or search. Filter No Man's Sky items dynamically."
	slug="items"
	structuredData={structuredData}
>
	<Breadcrumbs items={breadcrumbs} className="pt-4 mb-6" />
	<h1 class="text-center text-4xl sm:text-6xl mt-12 mb-3">Items</h1>
	<p class="mx-auto mb-12 max-w-3xl text-center text-sky-200/90">
		Browse every item in No Man's Sky. Use the filters to narrow by group, type, or search term.
	</p>

	<form class="mx-auto mb-8 flex max-w-4xl flex-wrap items-center justify-center gap-4" onsubmit="event.preventDefault();">
		<div>
			<label for="group-select" class="sr-only">Group</label>
			<select
				id="group-select"
				class="h-10 w-56 rounded border border-sky-700 bg-sky-900/50 px-3 text-white focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
			>
				<option value="">All groups</option>
				{groups.map((group) => (
					<option value={group}>{group}</option>
				))}
			</select>
		</div>
		<div>
			<label for="type-select" class="sr-only">Type</label>
			<select
				id="type-select"
				class="h-10 w-44 rounded border border-sky-700 bg-sky-900/50 px-3 text-white focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
			>
				<option value="">All types</option>
				{types.map((type) => (
					<option value={type}>{type.charAt(0).toUpperCase() + type.slice(1)}</option>
				))}
			</select>
		</div>
		<div>
			<label for="items-search-input" class="sr-only">Search</label>
			<input
				id="items-search-input"
				type="text"
				placeholder="Search by name..."
				class="h-10 rounded border border-sky-700 bg-sky-900/50 px-3 text-white placeholder-sky-400 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
			/>
		</div>
		<div class="flex gap-2">
			<button
				id="apply-filters"
				type="button"
				class="h-10 rounded bg-sky-600 px-4 font-semibold text-white transition-colors hover:bg-sky-500"
			>
				Apply
			</button>
			<button
				id="reset-filters"
				type="button"
				class="h-10 rounded border border-sky-600 px-4 font-semibold text-sky-400 transition-colors hover:bg-sky-900/50 hover:text-white"
			>
				Reset
			</button>
		</div>
	</form>

	<div id="empty" class="hidden py-12 text-center text-sky-400">
		No items found. Try adjusting your filters.
	</div>

	<script is:inline>
		(() => {
			const params = new URLSearchParams(window.location.search);
			const groupRaw = params.get('group') || '';
			const typeRaw = params.get('type') || '';
			const qRaw = params.get('q') || '';

			const group = groupRaw.trim().toLowerCase();
			const type = typeRaw.trim().toLowerCase();
			const q = qRaw.trim().toLowerCase();

			const groupSelect = document.getElementById('group-select');
			const typeSelect = document.getElementById('type-select');
			const searchInput = document.getElementById('items-search-input');

			if (groupSelect && groupRaw) groupSelect.value = groupRaw;
			if (typeSelect && typeRaw) typeSelect.value = typeRaw;
			if (searchInput && qRaw) searchInput.value = qRaw;

			if (!group && !type && !q) return;

			const cssEscape =
				typeof CSS !== 'undefined' && typeof CSS.escape === 'function'
					? CSS.escape.bind(CSS)
					: (value) => value.replace(/\\/g, '\\\\').replace(/"/g, '\\"');

			const hideSelectors = [];
			if (group) {
				hideSelectors.push(`.item-filter-entry:not([data-group="${cssEscape(group)}"])`);
			}
			if (type) {
				hideSelectors.push(`.item-filter-entry:not([data-type="${cssEscape(type)}"])`);
			}
			if (q) {
				const escapedQuery = cssEscape(q);
				hideSelectors.push(
					`.item-filter-entry:not([data-name*="${escapedQuery}"]):not([data-group*="${escapedQuery}"])`
				);
			}

			if (!hideSelectors.length) return;

			const style = document.createElement('style');
			style.id = 'items-initial-filter-style';
			style.textContent = `${hideSelectors.join(',')} { display: none !important; }`;
			document.head.appendChild(style);
		})();
	</script>

	<div id="items" class="grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8">
		{
			itemCards.map((item, index) => (
				<div
					class="item-filter-entry"
					data-name={item.name.toLowerCase()}
					data-group={item.group.toLowerCase()}
					data-type={item.type.toLowerCase()}
				>
					<CompactCard
						card={{
							name: item.name,
							image: `${IMAGE_BASE}${item.icon}`,
							link: item.url,
						}}
						index={index}
						loading="lazy"
					/>
				</div>
			))
		}
	</div>
</Layout>

<script>
	const groupSelect = document.getElementById('group-select') as HTMLSelectElement | null;
	const typeSelect = document.getElementById('type-select') as HTMLSelectElement | null;
	const searchInput = document.getElementById('items-search-input') as HTMLInputElement | null;
	const applyBtn = document.getElementById('apply-filters');
	const resetBtn = document.getElementById('reset-filters');
	const emptyEl = document.getElementById('empty');
	const initialFilterStyle = document.getElementById('items-initial-filter-style');
	const itemEls = Array.from(document.querySelectorAll('.item-filter-entry')) as HTMLElement[];

	const getParams = () => {
		const params = new URLSearchParams(window.location.search);
		return {
			group: params.get('group') || '',
			type: params.get('type') || '',
			q: params.get('q') || '',
		};
	};

	const updateUrl = (group: string, type: string, q: string) => {
		const params = new URLSearchParams();
		if (group) params.set('group', group);
		if (type) params.set('type', type);
		if (q) params.set('q', q);
		const query = params.toString();
		const newUrl = `/items${query ? `?${query}` : ''}`;
		window.history.replaceState({}, '', newUrl);
	};

	const applyFilters = () => {
		if (initialFilterStyle?.parentNode) {
			initialFilterStyle.parentNode.removeChild(initialFilterStyle);
		}

		const groupRaw = groupSelect?.value?.trim() || '';
		const typeRaw = typeSelect?.value?.trim() || '';
		const qRaw = searchInput?.value?.trim() || '';
		const group = groupRaw.toLowerCase();
		const type = typeRaw.toLowerCase();
		const q = qRaw.toLowerCase();

		let visibleCount = 0;
		itemEls.forEach((el) => {
			const name = el.dataset.name || '';
			const itemGroup = el.dataset.group || '';
			const itemType = el.dataset.type || '';

			const matchesGroup = !group || itemGroup === group;
			const matchesType = !type || itemType === type;
			const matchesSearch = !q || name.includes(q) || itemGroup.includes(q);

			if (matchesGroup && matchesType && matchesSearch) {
				el.classList.remove('hidden');
				visibleCount += 1;
			} else {
				el.classList.add('hidden');
			}
		});

		if (emptyEl) {
			if (visibleCount === 0) {
				emptyEl.classList.remove('hidden');
			} else {
				emptyEl.classList.add('hidden');
			}
		}

		updateUrl(groupRaw, type, qRaw);
	};

	const syncFromUrl = () => {
		const { group, type, q } = getParams();
		if (groupSelect) groupSelect.value = group;
		if (typeSelect) typeSelect.value = type;
		if (searchInput) searchInput.value = q;
	};

	const resetFilters = () => {
		if (groupSelect) groupSelect.value = '';
		if (typeSelect) typeSelect.value = '';
		if (searchInput) searchInput.value = '';
		applyFilters();
	};

	applyBtn?.addEventListener('click', applyFilters);
	resetBtn?.addEventListener('click', resetFilters);
	groupSelect?.addEventListener('change', applyFilters);
	typeSelect?.addEventListener('change', applyFilters);
	searchInput?.addEventListener('keydown', (event) => {
		if (event.key === 'Enter') {
			event.preventDefault();
			applyFilters();
		}
	});

	syncFromUrl();
	applyFilters();
</script>
