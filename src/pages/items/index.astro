---
import Layout from '@layouts/Layout.astro';

const IMAGE_BASE = 'https://nomansskyrecipes.com/images/items/';
---

<Layout
	title="Items | No Man's Sky Recipes"
	description="Browse items by group, type, or search. Filter No Man's Sky items dynamically."
	slug="items"
>
	<h1 class="text-center text-4xl sm:text-6xl my-12">Items</h1>

	<form
		class="mx-auto max-w-4xl mb-8 flex flex-wrap gap-4 justify-center items-center"
		onsubmit="event.preventDefault(); return false;"
	>
		<div class="relative" id="group-combobox-wrapper">
			<label for="group-input" class="sr-only">Group</label>
			<input
				id="group-input"
				type="text"
				autocomplete="off"
				placeholder="All groups"
				class="h-10 w-48 rounded border border-sky-700 bg-sky-900/50 px-3 text-white placeholder-sky-400 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
			/>
			<div
				id="group-dropdown"
				class="absolute left-0 right-0 top-full z-20 mt-1 max-h-60 overflow-y-auto rounded border border-sky-700 bg-sky-900 shadow-lg hidden"
			></div>
		</div>
		<div class="relative" id="type-combobox-wrapper">
			<label for="type-input" class="sr-only">Type</label>
			<input
				id="type-input"
				type="text"
				autocomplete="off"
				placeholder="All types"
				class="h-10 w-36 rounded border border-sky-700 bg-sky-900/50 px-3 text-white placeholder-sky-400 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
			/>
			<div
				id="type-dropdown"
				class="absolute left-0 right-0 top-full z-20 mt-1 max-h-60 overflow-y-auto rounded border border-sky-700 bg-sky-900 shadow-lg hidden"
			></div>
		</div>
		<div>
			<label for="items-search-input" class="sr-only">Search</label>
			<input
				id="items-search-input"
				type="text"
				placeholder="Search by name..."
				class="h-10 rounded border border-sky-700 bg-sky-900/50 px-3 text-white placeholder-sky-400 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
			/>
		</div>
		<div class="flex gap-2">
			<button
				id="apply-filters"
				type="button"
				class="h-10 rounded bg-sky-600 px-4 font-semibold text-white hover:bg-sky-500 transition-colors"
			>
				Apply
			</button>
			<button
				id="reset-filters"
				type="button"
				class="h-10 rounded border border-sky-600 px-4 font-semibold text-sky-400 hover:bg-sky-900/50 hover:text-white transition-colors"
			>
				Reset
			</button>
		</div>
	</form>

	<div id="loading" class="text-center py-12 text-sky-400">Loading...</div>
	<div id="empty" class="hidden text-center py-12 text-sky-400">
		No items found. Try adjusting your filters.
	</div>
	<div
		id="items"
		class="grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 hidden"
	></div>
</Layout>

<script define:vars={{ IMAGE_BASE }}>
	const groupInput = document.getElementById('group-input');
	const typeInput = document.getElementById('type-input');
	const groupDropdown = document.getElementById('group-dropdown');
	const typeDropdown = document.getElementById('type-dropdown');
	const searchInput = document.getElementById('items-search-input');
	const applyBtn = document.getElementById('apply-filters');
	const resetBtn = document.getElementById('reset-filters');
	const loadingEl = document.getElementById('loading');
	const emptyEl = document.getElementById('empty');
	const itemsEl = document.getElementById('items');

	let allItemsData = [];
	let allGroups = [];
	let allTypes = [];

	function getItemType(item) {
		return (item.url || '').split('/')[1] || '';
	}

	function getGroupsForType(type) {
		if (!type) return allGroups;
		const t = type.toLowerCase();
		return [...new Set(allItemsData.filter((i) => getItemType(i) === t).map((i) => i.group).filter(Boolean))].sort();
	}

	function getTypesForGroup(group) {
		if (!group) return allTypes;
		const g = group.trim();
		return [...new Set(allItemsData.filter((i) => i.group && String(i.group).trim() === g).map((i) => getItemType(i)))].sort().map((t) => t.charAt(0).toUpperCase() + t.slice(1));
	}

	function getParams() {
		const params = new URLSearchParams(window.location.search);
		return {
			group: params.get('group') || '',
			type: params.get('type') || '',
			q: params.get('q') || '',
		};
	}

	function syncInputsFromUrl() {
		const { group, type, q } = getParams();
		if (groupInput) groupInput.value = group;
		if (typeInput) typeInput.value = type ? type.charAt(0).toUpperCase() + type.slice(1) : '';
		if (searchInput) searchInput.value = q;
	}

	function updateUrl() {
		const group = groupInput?.value?.trim() || '';
		const type = (typeInput?.value?.trim() || '').toLowerCase();
		const q = searchInput?.value?.trim() || '';
		const params = new URLSearchParams();
		if (group) params.set('group', group);
		if (type) params.set('type', type);
		if (q) params.set('q', q);
		const query = params.toString();
		const newUrl = `/items${query ? '?' + query : ''}`;
		window.history.replaceState({}, '', newUrl);
	}

	function renderDropdown(list, filter) {
		const q = (filter || '').toLowerCase().trim();
		const filtered = list.filter((item) => item.toLowerCase().includes(q));
		const items = filtered.map(
			(item) =>
				`<button type="button" class="block w-full px-3 py-2 text-left text-sm text-white hover:bg-sky-700/80" data-value="${item.replace(/"/g, '&quot;')}">${item}</button>`
		);
		const clearBtn = '<button type="button" class="block w-full px-3 py-2 text-left text-sm text-sky-400 hover:bg-sky-700/80" data-value="">(All)</button>';
		return clearBtn + items.join('');
	}

	function setupCombobox(inputEl, dropdownEl, getOptions, onSelect) {
		if (!inputEl || !dropdownEl) return;
		function show() {
			const options = getOptions();
			dropdownEl.innerHTML = renderDropdown(options, inputEl.value);
			dropdownEl.classList.remove('hidden');
			dropdownEl.querySelectorAll('button').forEach((btn) => {
				btn.addEventListener('mousedown', (e) => e.preventDefault());
				btn.addEventListener('click', () => {
					inputEl.value = btn.dataset.value || '';
					dropdownEl.classList.add('hidden');
					onSelect();
				});
			});
		}
		function hide() {
			dropdownEl.classList.add('hidden');
		}
		inputEl.addEventListener('focus', show);
		inputEl.addEventListener('input', show);
		inputEl.addEventListener('blur', () => setTimeout(hide, 150));
		dropdownEl.addEventListener('mousedown', (e) => e.preventDefault());
	}

	function resetFilters() {
		if (groupInput) groupInput.value = '';
		if (typeInput) typeInput.value = '';
		if (searchInput) searchInput.value = '';
		groupDropdown?.classList.add('hidden');
		typeDropdown?.classList.add('hidden');
		loadItems();
	}

	function renderCard(item) {
		const article = document.createElement('article');
		article.className = 'group relative';
		article.innerHTML = `
			<a
				href="${item.url}"
				class="group block h-full overflow-hidden rounded-sm border border-sky-900 bg-sky-800/80 transition hover:-translate-y-0.5 hover:border-sky-400 hover:bg-sky-700/90"
			>
				<div class="aspect-square bg-[#0b3550]">
					<img
						class="h-full w-full object-contain object-center"
						src="${IMAGE_BASE}${item.icon}"
						alt="${item.name}"
						loading="lazy"
					/>
				</div>
				<div class="border-t border-sky-900 px-2 py-1.5">
					<p class="truncate text-base font-semibold text-white/95" title="${item.name}">${item.name}</p>
				</div>
			</a>
			<div
				class="pointer-events-none absolute bottom-full left-1/2 z-20 mb-2 w-max max-w-72 -translate-x-1/2 rounded-md border border-sky-400 bg-[#06283d] px-3 py-2 text-sm font-semibold text-white opacity-0 shadow-lg transition-opacity duration-150 group-hover:opacity-100 group-focus-within:opacity-100"
				role="tooltip"
			>
				${item.name}
			</div>
		`;
		return article;
	}

	function filterItems(items, group, type, q) {
		let filtered = items;
		if (group) {
			const g = group.trim();
			filtered = filtered.filter((item) => item.group && String(item.group).trim() === g);
		}
		if (type) {
			const t = type.toLowerCase().trim();
			filtered = filtered.filter((item) => {
				const itemType = (item.url || '').split('/')[1] || '';
				return itemType === t;
			});
		}
		if (q) {
			const search = q.toLowerCase().trim();
			filtered = filtered.filter(
				(item) =>
					(item.name && String(item.name).toLowerCase().includes(search)) ||
					(item.group && String(item.group).toLowerCase().includes(search))
			);
		}
		return filtered;
	}

	async function loadItems() {
		if (!loadingEl || !emptyEl || !itemsEl) return;

		loadingEl.classList.remove('hidden');
		emptyEl.classList.add('hidden');
		itemsEl.classList.add('hidden');
		itemsEl.innerHTML = '';

		const q = searchInput?.value?.trim() || '';

		try {
			// Fetch full list (static build serves one response; client filters)
			const res = await fetch('/items.json?v=2');
			const json = await res.json();
			const allItems = json?.body ?? [];
			let groups = json?.groups ?? [];
			let types = json?.types ?? [];

			// Fallback: derive from items if API didn't include them (e.g. cached response)
			if (!groups.length && allItems.length) {
				groups = [...new Set(allItems.map((i) => i.group).filter(Boolean))].sort();
			}
			if (!types.length && allItems.length) {
				types = [...new Set(allItems.map((i) => (i.url || '').split('/')[1]).filter(Boolean))].sort();
			}

			allItemsData = allItems;
			allGroups = groups;
			allTypes = types.map((t) => t.charAt(0).toUpperCase() + t.slice(1));

			// Setup comboboxes on first load only
			const didSetup = !groupDropdown?.dataset.ready;
			if (didSetup && groups.length && types.length) {
				groupDropdown.dataset.ready = '1';
				typeDropdown.dataset.ready = '1';
				setupCombobox(groupInput, groupDropdown, () => getGroupsForType(typeInput?.value?.trim()), loadItems);
				setupCombobox(typeInput, typeDropdown, () => getTypesForGroup(groupInput?.value?.trim()), loadItems);
			}
			if (didSetup) syncInputsFromUrl();

			const groupVal = groupInput?.value?.trim() || '';
			const typeVal = typeInput?.value?.trim()?.toLowerCase() || '';
			const items = filterItems(allItems, groupVal, typeVal, q);

			loadingEl.classList.add('hidden');

			if (items.length === 0) {
				emptyEl.classList.remove('hidden');
			} else {
				items.forEach((item) => itemsEl.appendChild(renderCard(item)));
				itemsEl.classList.remove('hidden');
			}

			updateUrl();
		} catch (err) {
			loadingEl.classList.add('hidden');
			emptyEl.textContent = 'Failed to load items. Please try again.';
			emptyEl.classList.remove('hidden');
		}
	}

	syncInputsFromUrl();

	applyBtn?.addEventListener('click', (e) => {
		e.preventDefault();
		loadItems();
	});
	resetBtn?.addEventListener('click', (e) => {
		e.preventDefault();
		resetFilters();
	});

	searchInput?.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			e.preventDefault();
			loadItems();
		}
	});

	loadItems();
</script>
