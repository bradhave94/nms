---
// Importing required components and data
import Layout from '@layouts/Layout.astro';
import Table from '@components/table/Table.astro';
import products from '@data/Products.json';
import { getById } from '@utils/lookup.js';
import type { Item, RequiredItem } from '@utils/lookup.js';
import type { TableRow } from '@components/table/Table.astro';

interface ItemDetails {
  id: string;
  name: string;
  description: string;
  value: number;
  amount?: number;
  image: string;
  colour: string;
}

const createItemDetails = (item: Item, quantity?: number): ItemDetails => ({
  id: item.Id,
  name: item.Name,
  description: item.Description,
  value: item.BaseValueUnits,
  ...(quantity && { amount: quantity }),
  image: item.Icon,
  colour: item.Colour,
});

const createArray = (item: Item): TableRow | undefined => {
  if (!('RequiredItems' in item) || !item.RequiredItems || item.RequiredItems.length === 0) return undefined;

  const requiredItems = item.RequiredItems.map((element: RequiredItem) => {
    const requiredItem = getById(element.Id);
    return requiredItem ? createItemDetails(requiredItem, element.Quantity) : undefined;
  }).filter((detail: ItemDetails | undefined): detail is ItemDetails => detail !== undefined);

  // Ensure all three required inputs exist (TableRow requires all three)
  if (requiredItems.length < 3 || !requiredItems[0] || !requiredItems[1] || !requiredItems[2]) return undefined;

  return {
    input_1: requiredItems[0],
    input_2: requiredItems[1],
    input_3: requiredItems[2],
    output: createItemDetails(item),
    value: item.BaseValueUnits,
  };
};

// Define the columns to be displayed in the table
const columns = [
	{ title: 'Input 1', field: 'input_1' },
	{ title: 'Input 2', field: 'input_2' },
	{ title: 'Input 3', field: 'input_3' },
	{ title: 'Product', field: 'output' },
	{ title: 'Value', field: 'value' },
];

// Map the data and create an array of filtered items with proper type guard
const data = products.map(createArray).filter((item): item is TableRow => item !== undefined);

---

<Layout
	title="Crafting Guide | No Man's Sky Recipes"
	description="Unlock new possibilities in No Man's Sky with our comprehensive Crafting Guide. Our guide has everything you need to take your game to the next level."
	slug="crafting-guide"
>
		<Table
			title="Crafting"
			image="crafting-guide"
			image_width={100}
			image_height={63}
			columns={columns}
			data={data}
			sort="value"
		 />
</Layout>