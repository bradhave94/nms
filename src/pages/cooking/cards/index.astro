---

// Importing required components and data
import Layout from '@layouts/Layout.astro';
import { Image } from 'astro:assets'
import processor from '@datav2/NutrientProcessor.json';
import { getById, getSlug, sortTable, type Item } from '@utils/lookup.js';

interface ItemDetails {
	id: string;
	name: string;
	description: string;
	value: number;
	amount?: number;
	image: string;
	colour: string;
	[key: string]: unknown;
}

interface ProcessedItem {
	input_1?: ItemDetails;
	input_2?: ItemDetails;
	input_3?: ItemDetails;
	output: ItemDetails;
	value: number;
	description?: string;
}

// Interfaces for defining the shape of input and output objects
interface Input {
	Id: string;
	Quantity: number;
}

interface Output {
	Id: string;
	Quantity: number;
}

interface Processor {
	Inputs: Input[];
	Output: Output;
}

// Function to create an array of data for each item
const createArray = (item: Processor): ProcessedItem | undefined => {

	// Map the inputs and get the details of each input item using `getById` function
	const inputs = item.Inputs.map((element) => {
		const i: Item | undefined = getById(element.Id);
		// If item is not found, return undefined
		if (!i) return;
		// Return the item details
		const details: ItemDetails = {
			id: i.Id,
			name: i.Name,
			description: i.Description,
			value: i.BaseValueUnits,
			amount: element.Quantity,
			image: i.Icon,
			colour: i.Colour,
		};
		return details;
	});

	// Get the details of the output item using `getById` function
	const o: Item | undefined = getById(item.Output.Id);
	// If item is not found, return undefined
	if (!o) return;
	// Return the item details
	const output: ItemDetails = {
		id: o.Id,
		name: o.Name,
		description: o.Description,
		value: o.BaseValueUnits,
		amount: item.Output.Quantity,
		image: o.Icon,
		colour: o.Colour,
	};

	// Combine the inputs and output data in a new object
	const newItem: ProcessedItem = {
		input_1: inputs[0],
		input_2: inputs[1],
		input_3: inputs[2],
		output,
		description: output.description,
		value: output.value,
	};
	return newItem;
};

// Define the columns to be displayed in the table (unused but kept for reference)
// const columns = [
// 	{ title: 'Input 1', field: 'input_1' },
// 	{ title: 'Input 2', field: 'input_2' },
// 	{ title: 'Input 3', field: 'input_3' },
// 	{ title: 'Output', field: 'output' }
// ];

// Map the data and create an array of filtered items
const data = processor.map(createArray).filter((item): item is ProcessedItem => item !== undefined);
const sortedData = sortTable(data);
---

<Layout
	title={"Cooking Recipes | No Man's Sky Recipes"}
	description="A list of cooking recipes items for No Man's Sky. Our guide has everything you need to take your game to the next level."
	slug="cooking"
>
	<div
		class="card-header mb-4 p-4 relative flex lg:flex-row flex-col gap-5 items-center justify-between bg-center before:bg-black/80 before:w-full before:h-full before:absolute before:left-0 before:top-0"
		style="background-image: url(/images/resources.png)"
	>
		<div class="flex items-center gap-2 z-10 relative">
			<Image
				class="logo"
				src={import(`../../../assets/img/cooking.png`)}
				sizes={60 + 'px'}
				width={60}
				height={60}
				alt="Refining"
			/>
			<h1 class="text-2xl">Cooking</h1>
		</div>

		<div class="relative text-center">
			<div class="flex gap-2 justify-center">
				<p>Layout:</p>
				<div>
					<a
						href={'/cooking'}
						class="block cursor-pointer select-none rounded-md px-2 transition-colors hover:bg-blue-500 hover:text-black border border-blue-500 peer-checked:bg-blue-500 peer-checked:text-black"
					>
						Table
					</a>
				</div>
				<div>
					<a
						href={'/' + "cooking" + '/cards'}
						class="block cursor-pointer select-none rounded-md px-2 border transition-colors bg-blue-500 text-black border-blue-500 peer-checked:bg-blue-500 peer-checked:text-black"
					>
						Cards
					</a>
				</div>
			</div>
		</div>

		<div class="flex items-center z-10">
			<div class="tabulator-search relative">
				<input
					class="rounded-md w-full bg-black border-blue-500 focus:border-blue-500 focus:ring-blue-500 peer"
					required
					type="text"
					id="search"
					name="search"
					placeholder=""
				/>
				<label
					class="absolute top-1/2 -translate-y-1/2 left-3 peer-focus:opacity-0 peer-valid:opacity-0"
					for="search">Search</label
				>
			</div>
		</div>
	</div>
	<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 lg:items-start gap-8" id="items">
		{
			sortedData.map((item) => (
				<div class="recipe-card bg-[#0b3550] rounded-md overflow-hidden text-left">
					<a
						href={getSlug(item.output.id)}
						class="flex items-center gap-3 text-lg w-full p-2 transition-opacity hover:opacity-75"
						style={'background: #' + item.output.colour}
					>
						<Image
							src={'https://nomansskyrecipes.com/images/items/' + item.output.image}
							alt={item.output.name}
							sizes="50px"
							width={50}
							height={50}
							class="flex-shrink-0"
						/>
						<h4 class="lg:text-lg flex items-center gap-2 min-w-0">
							<span class="output truncate">{item.output.name}</span>
							{item.output.amount != null && <span class="inline-flex items-center justify-center min-w-[1.75rem] rounded px-1.5 py-0.5 text-xs font-medium bg-black/30 text-gray-300 tabular-nums shrink-0" data-quantity={item.output.amount}>{item.output.amount.toLocaleString()}</span>}
						</h4>
					</a>
					<div class="w-full bg-[#0b3550] py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wide">
						Inputs
					</div>
					<div class="flex flex-col">
					{item.input_1 && (() => {
						const input1 = item.input_1;
						return (
							<a
								href={getSlug(input1.id)}
								class="flex pt-4 p-2 transition-opacity hover:opacity-75 items-center gap-3"
								style={'background: #' + input1.colour}
							>
								<div class="w-[50px] flex-shrink-0 flex justify-center">
									<Image
										src={
											'https://nomansskyrecipes.com/images/items/' +
											input1.image
										}
										alt={input1.name}
										sizes="50px"
										width={50}
										height={50}
									/>
								</div>
								<div class="flex items-center gap-2 min-w-0 flex-1">
									<h4 class="lg:text-lg flex items-center gap-2 truncate">
										{input1.name}
										{input1.amount != null && <span class="inline-flex items-center justify-center min-w-[1.75rem] rounded px-1.5 py-0.5 text-xs font-medium bg-black/30 text-gray-300 tabular-nums shrink-0" data-quantity={input1.amount}>{input1.amount.toLocaleString()}</span>}
									</h4>
								</div>
							</a>
						);
					})()}
					{item.input_2 && (() => {
						const input2 = item.input_2;
						return (
							<a
								href={getSlug(input2.id)}
								class="flex p-2 transition-opacity hover:opacity-75 items-center gap-3"
								style={'background: #' + input2.colour}
							>
								<div class="w-[50px] flex-shrink-0 flex justify-center">
									<Image
										src={
											'https://nomansskyrecipes.com/images/items/' +
											input2.image
										}
										alt={input2.name}
										sizes="50px"
										width={50}
										height={50}
									/>
								</div>
								<div class="flex items-center gap-2 min-w-0 flex-1">
									<h4 class="lg:text-lg flex items-center gap-2 truncate">
										{input2.name}
										{input2.amount != null && <span class="inline-flex items-center justify-center min-w-[1.75rem] rounded px-1.5 py-0.5 text-xs font-medium bg-black/30 text-gray-300 tabular-nums shrink-0" data-quantity={input2.amount}>{input2.amount.toLocaleString()}</span>}
									</h4>
								</div>
							</a>
						);
					})()}
					{item.input_3 && (() => {
						const input3 = item.input_3;
						return (
							<a
								href={getSlug(input3.id)}
								class="flex p-2 transition-opacity hover:opacity-75 items-center gap-3"
								style={'background: #' + input3.colour}
							>
								<div class="w-[50px] flex-shrink-0 flex justify-center">
									<Image
										src={
											'https://nomansskyrecipes.com/images/items/' +
											input3.image
										}
										alt={input3.name}
										sizes="50px"
										width={50}
										height={50}
									/>
								</div>
								<div class="flex items-center gap-2 min-w-0 flex-1">
									<h4 class="lg:text-lg flex items-center gap-2 truncate">
										{input3.name}
										{input3.amount != null && <span class="inline-flex items-center justify-center min-w-[1.75rem] rounded px-1.5 py-0.5 text-xs font-medium bg-black/30 text-gray-300 tabular-nums shrink-0" data-quantity={input3.amount}>{input3.amount.toLocaleString()}</span>}
									</h4>
								</div>
							</a>
						);
					})()}
					</div>
				</div>
			))
		}
	</div>


	<script>
		const search = document.querySelector('#search') as HTMLInputElement | null;
		const items = document.querySelector('#items') as HTMLElement | null;
		if (!search || !items) {
			console.error('Search elements not found');
		} else {
			const divs = items.querySelectorAll('div.recipe-card');
			let debounceTimer: ReturnType<typeof setTimeout> | undefined;

			function handleSearch(): void {
				if (!search) return;
				const filter = search.value.toUpperCase();

				divs.forEach((article) => {
					const a = article.querySelector('.output') as HTMLElement | null;
					if (!a) return;
					const txtValue = a.textContent || (a as HTMLElement).innerText;
					const isMatch = txtValue.toUpperCase().includes(filter);

					(article as HTMLElement).style.display = isMatch ? '' : 'none';
				});
			}

			function debounce(func: () => void, delay: number): void {
				if (debounceTimer) {
					clearTimeout(debounceTimer);
				}
				debounceTimer = setTimeout(func, delay);
			}

			search.addEventListener('input', () => debounce(handleSearch, 200));
		}
	</script>
</Layout>
